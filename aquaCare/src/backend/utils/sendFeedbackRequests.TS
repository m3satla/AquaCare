// src/cron/sendFeedbackRequests.ts
import Appointment from "../models/Appointment";
import User from "../models/User";
import nodemailer from "nodemailer";

// ×¤×•× ×§×¦×™×” ×¤× ×™××™×ª ×œ×©×œ×™×—×ª ××™×™×œ (×›××• utils/mailer)
const sendFeedbackEmail = async (to: string, appointmentId: string, name: string) => {
  const feedbackLink = `http://localhost:5173/feedback?appointmentId=${appointmentId}`;
  const subject = `× ×©××— ×œ×©××•×¢ ××ª ×“×¢×ª×š`; 
  const message = `×©×œ×•× ${name},\n\n×ª×•×“×” ×©×‘×™×§×¨×ª ××¦×œ× ×•! × ×©××— ×× ×ª×©×ª×£ ××•×ª× ×• ×‘×—×•×•×™×™×ª×š:\n${feedbackLink}`;

  const transporter = nodemailer.createTransport({
    service: "gmail",
    auth: {
      user: process.env.EMAIL_USER || "your_email@gmail.com",
      pass: process.env.EMAIL_PASS || "your_password",
    },
  });

  await transporter.sendMail({
    from: 'AquaCare <no-reply@aquacare.com>',
    to,
    subject,
    text: message,
  });

  console.log(`ğŸ“¨ ××©×•×‘ × ×©×œ×— ××œ ${to}`);
};

export const sendFeedbackRequests = async () => {
  console.log("ğŸ“¬ ×”×ª×—×œ×ª ×©×œ×™×—×ª ×‘×§×©×•×ª ×œ××©×•×‘...");

  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const dateStr = yesterday.toISOString().slice(0, 10);

  try {
    const appointments = await Appointment.find({
      date: dateStr,
      isCanceled: { $ne: true },
      isConfirmed: true,
    });

    for (const appt of appointments) {
      const client = await User.findOne({ id: appt.clientId });
      if (client?.email) {
        const appointmentId = String(appt._id); // âœ… ×”××¨×” ×‘×˜×•×—×” ×œ××—×¨×•×–×ª
        await sendFeedbackEmail(client.email, appointmentId, client.firstName);
      }
    }

    console.log("ğŸ‰ ×¡×™×•× ×©×œ×™×—×ª ×”××©×•×‘×™×.");
  } catch (err) {
    console.error("âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ××©×•×‘×™×:", err);
  }
};
